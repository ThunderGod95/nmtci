<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page.title }} | No Money to Cultivate Immortality</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Baskervville:ital,wght@0,400..700;1,400..700&family=Bitter:ital,wght@0,100..900;1,100..900&family=Caveat:wght@400..700&family=Coming+Soon&family=EB+Garamond:ital,wght@0,400..800;1,400..800&family=Indie+Flower&family=Literata:ital,opsz,wght@0,7..72,200..900;1,7..72,200..900&family=Merriweather:ital,wght@0,300..900;1,300..900&family=Merriweather+Sans:ital,wght@0,300..800;1,300..800&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Patrick+Hand&display=swap"
        rel="stylesheet" />
    <script>
        (function () {
            try {
                var savedSettings = localStorage.getItem("reader-settings");
                var theme = "light";
                if (savedSettings) {
                    theme = JSON.parse(savedSettings).theme || "light";
                }

                const themes = {
                    light: { bg: "#fdfdfd", text: "#333333" },
                    sepia: { bg: "#f4ecd8", text: "#5b4636" },
                    dark: { bg: "#222222", text: "#d1d1d1" },
                    midnight: { bg: "#2b323b", text: "#c4cdd5" },
                    forest: { bg: "#e8f5e9", text: "#2d3b2d" },
                    amoled: { bg: "#000000", text: "#b3b3b3" },
                };

                var activeTheme = themes[theme] || themes.light;
                var root = document.documentElement;

                root.style.setProperty("--bg-color", activeTheme.bg);
                root.style.setProperty("--text-color", activeTheme.text);

                root.setAttribute("data-theme", theme);
            } catch (e) {
                console.error("Theme initialization failed", e);
            }
        })();
    </script>
    <style>
        :root {
            --font-family: "Open Sans", sans-serif;
            --text-size: 16px;
            --line-height: 1.6;
            --bg-color: #fdfdfd;
            --text-color: #333;
            --accent-color: #333;
            --menu-bg: #f5f5f7;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: #e0e0e0;
            --hover-bg: rgba(0, 0, 0, 0.05);
            --content-width: 800px;
            --letter-spacing: 0px;
            --para-indent: 0;
            --para-margin: 1em;
        }

        [data-theme="dark"] {
            --menu-bg: #2d2d2d;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --border-color: #444;
            --accent-color: #fff;
            --hover-bg: rgba(255, 255, 255, 0.1);
        }

        [data-theme="sepia"] {
            --menu-bg: #fff9ea;
            --border-color: #dccfb7;
            --accent-color: #5b4636;
            --hover-bg: rgba(91, 70, 54, 0.1);
        }

        [data-theme="midnight"] {
            --bg-color: #2b323b;
            --menu-bg: #36404a;
            --text-color: #c4cdd5;
            --border-color: #4a5563;
            --accent-color: #8ab4f8;
            --hover-bg: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        [data-theme="forest"] {
            --bg-color: #e8f5e9;
            --menu-bg: #dceddc;
            --text-color: #2d3b2d;
            --border-color: #b8daba;
            --accent-color: #2e7d32;
            --hover-bg: rgba(46, 125, 50, 0.1);
            --shadow-color: rgba(45, 59, 45, 0.15);
        }

        [data-theme="amoled"] {
            --bg-color: #000000;
            --menu-bg: #1a1a1a;
            --text-color: #b3b3b3;
            --border-color: #333333;
            --accent-color: #ffffff;
            --hover-bg: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            max-width: none;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: var(--text-size);
            line-height: var(--line-height);
            font-family: var(--font-family);
            letter-spacing: var(--letter-spacing);
            transition:
                font-size 0.1s ease-in-out,
                line-height 0.1s ease-in-out,
                width 0.1s ease-in-out,
                background-color 0.1s ease-in-out,
                color 0.1s ease-in-out;
            overflow-x: hidden;
        }

        #content {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            padding-top: 0;
        }

        #content p {
            text-indent: var(--para-indent);
            margin-bottom: var(--para-margin);
            margin-top: 0;
        }

        #progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: transparent;
            z-index: 2000;
        }

        #progress-bar {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.1s;
            opacity: 0.8;
        }

        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            pointer-events: none;
            transition:
                transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                opacity 0.3s ease;
            opacity: 1;
        }

        .fab-container.fab-hidden {
            transform: translateY(100px);
            opacity: 0;
        }

        .settings-btn {
            background-color: var(--text-color);
            color: var(--bg-color);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            box-shadow: 0 4px 12px var(--shadow-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .settings-btn:hover {
            transform: scale(1.1);
        }

        .settings-btn svg {
            fill: var(--bg-color);
            width: 24px;
            height: 24px;
        }

        .settings-menu {
            background: var(--menu-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px -10px var(--shadow-color);
            width: 300px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.98);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: bottom right;
        }

        .settings-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .setting-item {
            margin-bottom: 20px;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .setting-item label {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-color);
            opacity: 0.8;
        }

        .value-display {
            font-size: 13px;
            font-weight: bold;
            color: var(--text-color);
        }

        .settings-btn,
        .settings-menu {
            pointer-events: auto;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]:focus {
            outline: none;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: var(--border-color);
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--text-color);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            content: "▼";
            font-size: 10px;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-color);
        }

        select {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-color);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select option {
            background-color: var(--menu-bg);
            color: var(--text-color);
        }

        select:hover {
            border-color: var(--text-color);
        }

        select:focus {
            outline: none;
            border-color: var(--text-color);
            box-shadow: 0 0 0 2px var(--shadow-color);
        }

        .theme-selector {
            display: flex;
            gap: 12px;
            background: var(--border-color);
            padding: 6px;
            border-radius: 50px;
            width: fit-content;
        }

        .theme-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .theme-btn.active {
            transform: scale(1.1);
            border-color: var(--text-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .chapter-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
            user-select: none;
        }

        .sticky-bar {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 900;
            width: 100%;
            background-color: var(--bg-color);
            padding: 15px 0;
            border-bottom: 1px solid transparent;
            transition:
                box-shadow 0.3s ease,
                border-color 0.3s ease;
        }

        .bottom-nav {
            padding-top: 20px;
            padding-bottom: 60px;
        }

        .sticky-bar.stuck {
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -4px var(--shadow-color);
        }

        .nav-link {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: 1px solid var(--border-color);
            border-radius: 50px;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            background-color: transparent;
            min-width: 120px;
        }

        .nav-link:not(.disabled):hover {
            background-color: var(--text-color);
            color: var(--bg-color);
            border-color: var(--text-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .nav-link:active {
            transform: scale(0.95);
        }

        .nav-link.disabled {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }

        #sentinel {
            position: absolute;
            top: 0;
            left: 0;
            height: 1px;
            width: 100%;
            pointer-events: none;
            visibility: hidden;
        }

        .chapter-nav.sticky-top {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 900;
            background-color: var(--bg-color);
            margin-top: 0;
            margin-bottom: 20px;
            padding: 15px 20px;
            border-bottom: 1px solid transparent;
            box-shadow: none;
            transition:
                box-shadow 0.3s ease,
                border-color 0.3s ease;
        }

        .chapter-nav.sticky-top.stuck {
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -4px var(--shadow-color);
        }

        .page-footer {
            text-align: center;
            padding: 0 20px 60px;
            margin-top: -30px;
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
            font-family: var(--font-family);
        }

        .discord-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 16px;
            margin: 20px auto;
            background-color: #5865f2;
            color: #ffffff !important;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 13px;
            line-height: 1;
            border: 1px solid #5865f2;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .discord-btn:hover {
            background-color: #4752c4;
            border-color: #4752c4;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px var(--shadow-color);
        }

        .discord-btn:active {
            transform: scale(0.96);
        }

        [data-theme="sepia"] .discord-btn {
            filter: sepia(0.15);
        }

        .active-reading {
            background-color: var(--hover-bg);
            border-left: 4px solid var(--accent-color);
            padding-left: 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        @media (max-width: 600px) {
            body {
                padding-top: 20px;
            }

            .chapter-nav {
                margin: 0;
                gap: 8px;
            }

            #content {
                padding-top: 15px;
            }

            .settings-menu {
                position: fixed;
                width: auto;
                left: 20px;
                right: 20px;
                bottom: 100px;
                margin-bottom: 0;
                transform-origin: bottom center;
            }

            .nav-link {
                padding: 10px 5px;
                flex: 1;
                min-width: 0;
                font-size: 0.85rem;
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
            }

            .chapter-nav.sticky-top {
                padding: 10px 15px;
            }

            h1 {
                font-size: 1.5rem;
                line-height: 1.3;
                margin-top: 0;
                margin-bottom: 20px;
            }
        }

        .audio-toolbar-wrapper {
            max-width: 800px;
            margin: 20px auto 30px;
            padding: 0 20px;
            position: relative;
            z-index: 5;
        }

        .audio-toolbar-wrapper.floating {
            position: fixed;
            top: 85px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 950;
            margin: 0;
            width: auto;
            border-radius: 50px;
            animation: slideInFade 0.3s ease-out;
        }

        .audio-toolbar {
            display: flex;
            align-items: center;
            background: var(--menu-bg);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            padding: 6px 8px;
            width: fit-content;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: all 0.3s ease;
        }

        .audio-toolbar:hover {
            box-shadow: 0 4px 15px var(--shadow-color);
            transform: translateY(-1px);
        }

        .audio-main-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px 8px 12px;
            border-radius: 40px;
            color: var(--text-color);
            font-family: var(--font-family);
            font-weight: 600;
            font-size: 0.95rem;
            transition: background 0.2s;
        }

        .audio-main-btn:hover {
            background: var(--hover-bg);
        }

        .audio-main-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--accent-color);
        }

        .audio-separator {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 4px;
        }

        .audio-settings-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            opacity: 0.7;
        }

        .audio-settings-btn:hover {
            background: var(--hover-bg);
            opacity: 1;
        }

        .audio-settings-btn svg {
            width: 20px;
            height: 20px;
        }

        .audio-menu {
            position: absolute;
            top: 100%;
            left: 20px;
            margin-top: 10px;
            background: var(--menu-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 16px;
            width: 300px;
            box-shadow: 0 10px 40px var(--shadow-color);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 100;
        }

        .audio-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .audio-toolbar-wrapper.floating .audio-menu {
            top: 110%;
            left: 50%;
            transform: translateX(-50%);
        }

        @keyframes slideInFade {
            from {
                opacity: 0;
                transform: translate(-50%, -10px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
    </style>
</head>

<body>
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>

    <div id="sentinel"></div>

    <div class="sticky-bar" id="topNav">
        <nav class="chapter-nav">
            <a class="nav-link nav-prev">← Previous</a>
            <a class="nav-link nav-toc" href="../">Index</a>
            <a class="nav-link nav-next">Next →</a>
        </nav>
    </div>

    <div class="audio-toolbar-wrapper">
        <div class="audio-toolbar">
            <button id="toggleAudio" class="audio-main-btn" aria-label="Play Audio">
                <svg id="icon-play" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z" />
                </svg>
                <svg id="icon-pause" style="display: none;" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                </svg>
                <span id="audio-status-text">Listen</span>
            </button>

            <div class="audio-separator"></div>

            <button id="toggleAudioSettings" class="audio-settings-btn" aria-label="Audio Options">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z" />
                </svg>
            </button>
        </div>

        <div id="audioSettingsMenu" class="audio-menu">
            <div class="setting-item">
                <div class="setting-header">
                    <label>Voice</label>
                </div>
                <div class="select-wrapper">
                    <select id="input-voice"></select>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <label>Speed</label>
                    <span id="rate-val" class="value-display">1x</span>
                </div>
                <input type="range" id="input-rate" min="0.5" max="2" step="0.1" value="1">
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <label>Pitch</label>
                    <span id="pitch-val" class="value-display">1</span>
                </div>
                <input type="range" id="input-pitch" min="0" max="2" step="0.1" value="1">
            </div>
        </div>
    </div>

    <div id="content">{{ content }}</div>

    <div style="text-align: center">
        <a href="https://discord.gg/YWpdPycmWk" class="discord-btn" target="_blank" rel="noopener noreferrer">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M20.317 4.3698a19.7913 19.7913 0 0 0-4.8851-1.5152.0741.0741 0 0 0-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 0 0-.0785-.037 19.7363 19.7363 0 0 0-4.8852 1.515.0699.0699 0 0 0-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 0 0 .0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 0 0 .0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 0 0-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 0 1-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 0 1 .0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 0 1 .0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 0 1-.0066.1276 12.2986 12.2986 0 0 1-1.873.8914.0766.0766 0 0 0-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 0 0 .0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 0 0 .0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 0 0-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.419-2.1568 2.419zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.419-2.1568 2.419z" />
            </svg>
            Join the conversation on Discord
        </a>
    </div>

    <nav class="chapter-nav bottom-nav">
        <a class="nav-link nav-prev">← Previous</a>
        <a class="nav-link nav-toc" href="../">Index</a>
        <a class="nav-link nav-next">Next →</a>
    </nav>

    <footer class="page-footer">
        Translated with ❤️ by Nameless &amp; Thundergod95
    </footer>

    <div class="fab-container">
        <div class="settings-menu" id="settingsMenu">
            <div class="setting-item">
                <div class="setting-header">
                    <label>Font Size</label>
                    <span id="fs-val" class="value-display">18px</span>
                </div>
                <input type="range" id="input-fontsize" min="14" max="32" value="18" />
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <label>Line Height</label>
                    <span id="lh-val" class="value-display">1.6</span>
                </div>
                <input type="range" id="input-lineheight" min="1.2" max="2.4" step="0.1" value="1.6" />
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <label>Letter Spacing</label>
                    <span id="spacing-val" class="value-display">0px</span>
                </div>
                <input type="range" id="input-spacing" min="-1" max="3" step="0.5" value="0" />
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <label>Paragraph Style</label>
                </div>
                <div class="select-wrapper">
                    <select id="input-para-style">
                        <option value="block">Block (Web Default)</option>
                        <option value="indent">
                            Indented (Classic Book)
                        </option>
                    </select>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <label for="input-font">Typeface</label>
                </div>
                <div class="select-wrapper">
                    <select id="input-font">
                        <option value="'Open Sans', sans-serif">
                            Open Sans (Sans)
                        </option>
                        <option value="'Merriweather Sans', sans-serif">
                            Merriweather Sans (Sans)
                        </option>
                        <option value="'Nunito Sans', sans-serif">
                            Nunito Sans (Sans)
                        </option>

                        <option value="'Baskervville', serif">
                            Baskervville (Serif)
                        </option>
                        <option value="'Bitter', serif">
                            Bitter (Serif)
                        </option>
                        <option value="'EB Garamond', serif">
                            EB Garamond (Serif)
                        </option>
                        <option value="'Literata', serif">
                            Literata (Serif)
                        </option>
                        <option value="'Merriweather', serif">
                            Merriweather (Serif)
                        </option>

                        <option value="'Coming Soon', cursive">
                            Coming Soon
                        </option>
                        <option value="'Caveat', cursive">Caveat</option>
                        <option value="'Indie Flower', cursive">
                            Indie Flower
                        </option>
                        <option value="'Patrick Hand', cursive">
                            Patrick Hand
                        </option>
                    </select>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <label>Theme</label>
                </div>
                <div class="theme-selector">
                    <button class="theme-btn" data-theme="light" style="background-color: #fdfdfd"
                        aria-label="Light"></button>
                    <button class="theme-btn" data-theme="sepia" style="background-color: #f4ecd8"
                        aria-label="Sepia"></button>
                    <button class="theme-btn" data-theme="dark" style="background-color: #222222"
                        aria-label="Dark"></button>

                    <button class="theme-btn" data-theme="midnight" style="background-color: #2b323b"
                        aria-label="Midnight"></button>
                    <button class="theme-btn" data-theme="forest" style="background-color: #e8f5e9"
                        aria-label="Forest"></button>
                    <button class="theme-btn" data-theme="amoled" style="
                                background-color: #000000;
                                border: 1px solid #444;
                            " aria-label="AMOLED"></button>
                </div>
            </div>
        </div>

        <button class="settings-btn" id="toggleSettings" aria-label="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 640 640">
                <path
                    d="M259.1 73.5C262.1 58.7 275.2 48 290.4 48L350.2 48C365.4 48 378.5 58.7 381.5 73.5L396 143.5C410.1 149.5 423.3 157.2 435.3 166.3L503.1 143.8C517.5 139 533.3 145 540.9 158.2L570.8 210C578.4 223.2 575.7 239.8 564.3 249.9L511 297.3C511.9 304.7 512.3 312.3 512.3 320C512.3 327.7 511.8 335.3 511 342.7L564.4 390.2C575.8 400.3 578.4 417 570.9 430.1L541 481.9C533.4 495 517.6 501.1 503.2 496.3L435.4 473.8C423.3 482.9 410.1 490.5 396.1 496.6L381.7 566.5C378.6 581.4 365.5 592 350.4 592L290.6 592C275.4 592 262.3 581.3 259.3 566.5L244.9 496.6C230.8 490.6 217.7 482.9 205.6 473.8L137.5 496.3C123.1 501.1 107.3 495.1 99.7 481.9L69.8 430.1C62.2 416.9 64.9 400.3 76.3 390.2L129.7 342.7C128.8 335.3 128.4 327.7 128.4 320C128.4 312.3 128.9 304.7 129.7 297.3L76.3 249.8C64.9 239.7 62.3 223 69.8 209.9L99.7 158.1C107.3 144.9 123.1 138.9 137.5 143.7L205.3 166.2C217.4 157.1 230.6 149.5 244.6 143.4L259.1 73.5zM320.3 400C364.5 399.8 400.2 363.9 400 319.7C399.8 275.5 363.9 239.8 319.7 240C275.5 240.2 239.8 276.1 240 320.3C240.2 364.5 276.1 400.2 320.3 400z" />
            </svg>
        </button>
    </div>

    <script>
        const STORAGE_KEY_SETTINGS = "reader-settings";
        const STORAGE_KEY_SCROLL_PREFIX = "reader-scroll-";
        const SCROLL_KEY =
            STORAGE_KEY_SCROLL_PREFIX +
            window.location.pathname +
            window.location.search;

        const THEMES = {
            light: { bg: "#fdfdfd", text: "#333333" },
            sepia: { bg: "#f4ecd8", text: "#5b4636" },
            dark: { bg: "#222222", text: "#d1d1d1" },
            midnight: { bg: "#2b323b", text: "#c4cdd5" },
            forest: { bg: "#e8f5e9", text: "#2d3b2d" },
            amoled: { bg: "#000000", text: "#b3b3b3" },
        };

        const PREV_CHAPTER_NUM = "{{ page.prev }}";
        const NEXT_CHAPTER_NUM = "{{ page.next }}";
        const PREV_CHAPTER_URL = PREV_CHAPTER_NUM
            ? `${PREV_CHAPTER_NUM}.html`
            : "";
        const NEXT_CHAPTER_URL = NEXT_CHAPTER_NUM
            ? `${NEXT_CHAPTER_NUM}.html`
            : "";

        const root = document.documentElement;
        const fabContainer = document.querySelector(".fab-container");

        // Navigation
        const navBar = document.getElementById("topNav");
        const sentinel = document.getElementById("sentinel");
        const prevLinks = document.querySelectorAll(".nav-prev");
        const nextLinks = document.querySelectorAll(".nav-next");

        // Settings Menu UI
        const menu = document.getElementById("settingsMenu");
        const toggleBtn = document.getElementById("toggleSettings");
        const themeBtns = document.querySelectorAll(".theme-btn");
        const progressBar = document.getElementById("progress-bar");

        // Inputs & Displays
        const inputs = {
            fontSize: document.getElementById("input-fontsize"),
            lineHeight: document.getElementById("input-lineheight"),
            fontFamily: document.getElementById("input-font"),
            spacing: document.getElementById("input-spacing"),
            paraStyle: document.getElementById("input-para-style"),
        };

        const displays = {
            fontSize: document.getElementById("fs-val"),
            lineHeight: document.getElementById("lh-val"),
            spacing: document.getElementById("spacing-val"),
        };

        // Audio
        const audioBtn = document.getElementById("toggleAudio");
        const iconPlay = document.getElementById("icon-play");
        const iconPause = document.getElementById("icon-pause");
        const voiceSelect = document.getElementById("input-voice");
        const rateInput = document.getElementById("input-rate");
        const pitchInput = document.getElementById("input-pitch");
        const rateValDisplay = document.getElementById("rate-val");
        const pitchValDisplay = document.getElementById("pitch-val");
        const audioSettingsBtn = document.getElementById("toggleAudioSettings");
        const audioMenu = document.getElementById("audioSettingsMenu");
        const audioStatusText = document.getElementById("audio-status-text");

        let lastScrollTop = 0;
        let synth = window.speechSynthesis;
        let currentUtterance = null;
        let isPlaying = false;
        let isPaused = false;
        let paraObjects = [];
        let currentParaIndex = 0;
        let voices = [];

        function populateVoiceList() {
            voices = synth.getVoices();
            voiceSelect.innerHTML = '';

            const englishVoices = voices.filter(v => v.lang.includes('en'));

            englishVoices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.setAttribute('data-index', index);
                voiceSelect.appendChild(option);
            });

            loadAudioSettings();
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        } else {
            populateVoiceList();
        }

        function saveAudioSettings() {
            const settings = {
                rate: rateInput.value,
                pitch: pitchInput.value,
                voiceName: voiceSelect.selectedOptions[0]?.textContent
            };
            localStorage.setItem('reader-audio-settings', JSON.stringify(settings));
        }

        function loadAudioSettings() {
            const saved = JSON.parse(localStorage.getItem('reader-audio-settings'));
            if (saved) {
                rateInput.value = saved.rate;
                pitchInput.value = saved.pitch;
                rateValDisplay.textContent = saved.rate + 'x';
                pitchValDisplay.textContent = saved.pitch;

                for (let i = 0; i < voiceSelect.options.length; i++) {
                    if (voiceSelect.options[i].textContent === saved.voiceName) {
                        voiceSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        }

        function loadParagraphs() {
            const contentDiv = document.getElementById("content");
            paraObjects = Array.from(contentDiv.getElementsByTagName("p"))
                .filter(p => p.innerText.trim().length > 0)
                .map(p => ({ element: p, text: p.innerText }));
        }

        function clearHighlights() {
            paraObjects.forEach(obj => obj.element.classList.remove("active-reading"));
        }

        function speakParagraph(index) {
            if (index > paraObjects.length) {
                stopAudio();
                return;
            }

            synth.cancel();

            currentParaIndex = index;
            const pObj = paraObjects[index];

            clearHighlights();
            pObj.element.classList.add("active-reading");
            pObj.element.scrollIntoView({ behavior: "smooth", block: "center" });

            currentUtterance = new SpeechSynthesisUtterance(pObj.text);
            const selectedOption = voiceSelect.selectedOptions[0];
            if (selectedOption) {
                const voiceIndex = selectedOption.getAttribute('data-index');
                currentUtterance.voice = voices[voiceIndex];
            }
            currentUtterance.rate = parseFloat(rateInput.value);
            currentUtterance.pitch = parseFloat(pitchInput.value);

            currentUtterance.onend = () => {
                if (isPlaying && !isPaused) {
                    speakParagraph(currentParaIndex + 1);
                }
            };

            currentUtterance.onerror = (e) => {
                console.error("Audio error", e);
                stopAudio();
            };

            synth.speak(currentUtterance);
        }

        function toggleAudio() {
            if (!isPlaying) {
                loadParagraphs();
                if (paraObjects.length === 0) return;

                isPlaying = true;
                isPaused = false;
                updateAudioUI();
                speakParagraph(currentParaIndex);
            } else if (isPlaying && !isPaused) {
                synth.pause();
                isPaused = true;
                updateAudioUI();
            } else if (isPlaying && isPaused) {
                if (synth.paused) {
                    synth.resume();
                } else {
                    speakParagraph(currentParaIndex);
                }
                isPaused = false;
                updateAudioUI();
            }
        }

        function stopAudio() {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            currentParaIndex = 0;
            clearHighlights();
            updateAudioUI();
        }

        function updateAudioUI() {
            const wrapper = document.querySelector('.audio-toolbar-wrapper');
            const statusText = document.getElementById("audio-status-text");

            if (isPlaying) {
                wrapper.classList.add('floating');
                // document.body.style.paddingTop = "80px";
            } else {
                wrapper.classList.remove('floating');
                document.body.style.paddingTop = "0";
            }

            if (isPlaying && !isPaused) {
                iconPlay.style.display = "none";
                iconPause.style.display = "block";
                statusText.textContent = "Pause";
            } else if (isPlaying && isPaused) {
                iconPlay.style.display = "block";
                iconPause.style.display = "none";
                statusText.textContent = "Resume";
            } else {
                iconPlay.style.display = "block";
                iconPause.style.display = "none";
                statusText.textContent = "Listen";
            }
        }

        function applyTheme(themeName) {
            const theme = THEMES[themeName] || THEMES.light;

            root.style.setProperty("--bg-color", theme.bg);
            root.style.setProperty("--text-color", theme.text);
            root.setAttribute("data-theme", themeName);

            themeBtns.forEach((btn) => {
                if (btn.dataset.theme === themeName) {
                    btn.classList.add("active");
                } else {
                    btn.classList.remove("active");
                }
            });

            return themeName;
        }

        function applyParaStyle(style) {
            if (style === "indent") {
                root.style.setProperty("--para-indent", "2em");
                root.style.setProperty("--para-margin", "0");
            } else {
                root.style.setProperty("--para-indent", "0");
                root.style.setProperty("--para-margin", "1em");
            }
        }

        function saveSettings() {
            const activeBtn = document.querySelector(".theme-btn.active");
            const currentTheme = activeBtn
                ? activeBtn.dataset.theme
                : "light";

            const settings = {
                fontSize: inputs.fontSize.value,
                lineHeight: inputs.lineHeight.value,
                theme: currentTheme,
                fontFamily: inputs.fontFamily.value,
                letterSpacing: inputs.spacing.value,
                paraStyle: inputs.paraStyle.value,
            };

            localStorage.setItem(
                STORAGE_KEY_SETTINGS,
                JSON.stringify(settings),
            );
        }

        function loadSettings() {
            const savedSettings =
                localStorage.getItem(STORAGE_KEY_SETTINGS);

            if (savedSettings) {
                const settings = JSON.parse(savedSettings);

                root.style.setProperty(
                    "--text-size",
                    settings.fontSize + "px",
                );
                root.style.setProperty(
                    "--line-height",
                    settings.lineHeight,
                );

                if (settings.fontFamily) {
                    root.style.setProperty(
                        "--font-family",
                        settings.fontFamily,
                    );
                    inputs.fontFamily.value = settings.fontFamily;
                }

                if (settings.letterSpacing) {
                    root.style.setProperty(
                        "--letter-spacing",
                        settings.letterSpacing + "px",
                    );
                    inputs.spacing.value = settings.letterSpacing;
                    displays.spacing.textContent =
                        settings.letterSpacing + "px";
                }

                if (settings.paraStyle) {
                    inputs.paraStyle.value = settings.paraStyle;
                    applyParaStyle(settings.paraStyle);
                }

                inputs.fontSize.value = settings.fontSize;
                inputs.lineHeight.value = settings.lineHeight;
                displays.fontSize.textContent = settings.fontSize + "px";
                displays.lineHeight.textContent = settings.lineHeight;

                applyTheme(settings.theme || "light");
            } else {
                applyTheme("light");
            }

            const savedScroll = localStorage.getItem(SCROLL_KEY);
            if (savedScroll) {
                setTimeout(() => {
                    window.scrollTo(0, parseInt(savedScroll));
                }, 100);
            }
        }

        function changeFontSize(delta) {
            const currentVal = parseInt(inputs.fontSize.value);
            const minVal = parseInt(inputs.fontSize.min);
            const maxVal = parseInt(inputs.fontSize.max);

            let newVal = currentVal + delta;

            if (newVal >= minVal && newVal <= maxVal) {
                inputs.fontSize.value = newVal;
                inputs.fontSize.dispatchEvent(new Event("input"));
            }
        }

        function updateNavigation() {
            const updateLinks = (links, url) => {
                links.forEach((link) => {
                    if (url && url.trim() !== "") {
                        link.href = url;
                        link.classList.remove("disabled");
                    } else {
                        link.removeAttribute("href");
                        link.classList.add("disabled");
                    }
                });
            };

            updateLinks(prevLinks, PREV_CHAPTER_URL);
            updateLinks(nextLinks, NEXT_CHAPTER_URL);
        }

        function updateProgress() {
            const scrollTop = window.scrollY;
            const docHeight =
                document.body.scrollHeight - window.innerHeight;
            const scrollPercent = (scrollTop / docHeight) * 100;

            progressBar.style.width = scrollPercent + "%";
            localStorage.setItem(SCROLL_KEY, scrollTop);
        }

        function handleScrollFAB() {
            const scrollTop =
                window.scrollY || document.documentElement.scrollTop;

            if (Math.abs(scrollTop - lastScrollTop) < 10) return;

            const isScrollingDown = scrollTop > lastScrollTop;
            const isMenuOpen = menu.classList.contains("active");

            if (isScrollingDown && scrollTop > 50 && !isMenuOpen) {
                fabContainer.classList.add("fab-hidden");
            } else if (!isScrollingDown) {
                fabContainer.classList.remove("fab-hidden");
            }

            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
        }

        function saveReadingHistory() {
            const pathSegments = window.location.pathname.split("/");
            const fileName = pathSegments[pathSegments.length - 1];
            const chapterId = parseInt(fileName.replace(".html", ""), 10);

            const chapterTitle = `{{ page.title }}`;

            const history = {
                id: chapterId,
                title: chapterTitle,
                url: window.location.href,
                timestamp: Date.now(),
            };

            localStorage.setItem(
                "nmtci-last-read",
                JSON.stringify(history),
            );
        }

        audioSettingsBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            audioMenu.classList.toggle("active");
            menu.classList.remove("active");
        });

        document.addEventListener("click", (e) => {
            if (audioMenu.classList.contains("active") && !audioMenu.contains(e.target) && e.target !== audioSettingsBtn) {
                audioMenu.classList.remove("active");
            }
        });

        audioMenu.addEventListener("click", (e) => {
            e.stopPropagation();
        });

        rateInput.addEventListener('input', (e) => {
            rateValDisplay.textContent = e.target.value + 'x';
            saveAudioSettings();
            if (isPlaying && !isPaused) speakParagraph(currentParaIndex);
        });

        pitchInput.addEventListener('input', (e) => {
            pitchValDisplay.textContent = e.target.value;
            saveAudioSettings();
            if (isPlaying && !isPaused) speakParagraph(currentParaIndex);
        });

        voiceSelect.addEventListener('change', () => {
            saveAudioSettings();
            if (isPlaying && !isPaused) speakParagraph(currentParaIndex);
        });

        audioBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            toggleAudio();
        });

        window.addEventListener("beforeunload", () => {
            synth.cancel();
        });

        inputs.fontSize.addEventListener("input", (e) => {
            const val = e.target.value;
            root.style.setProperty("--text-size", val + "px");
            displays.fontSize.textContent = val + "px";
            saveSettings();
        });

        inputs.lineHeight.addEventListener("input", (e) => {
            const val = e.target.value;
            root.style.setProperty("--line-height", val);
            displays.lineHeight.textContent = val;
            saveSettings();
        });

        inputs.spacing.addEventListener("input", (e) => {
            const val = e.target.value;
            root.style.setProperty("--letter-spacing", val + "px");
            displays.spacing.textContent = val + "px";
            saveSettings();
        });

        inputs.fontFamily.addEventListener("change", (e) => {
            root.style.setProperty("--font-family", e.target.value);
            saveSettings();
        });

        inputs.paraStyle.addEventListener("change", (e) => {
            applyParaStyle(e.target.value);
            saveSettings();
        });

        themeBtns.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                applyTheme(e.target.dataset.theme);
                saveSettings();
            });
        });

        toggleBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            menu.classList.toggle("active");
        });

        document.addEventListener("click", (e) => {
            if (
                menu.classList.contains("active") &&
                !menu.contains(e.target)
            ) {
                menu.classList.remove("active");
            }
        });

        menu.addEventListener("click", (e) => {
            e.stopPropagation();
        });

        document.addEventListener("keydown", (e) => {
            switch (e.key) {
                case "ArrowLeft":
                    if (PREV_CHAPTER_URL)
                        window.location.href = PREV_CHAPTER_URL;
                    break;
                case "ArrowRight":
                    if (NEXT_CHAPTER_URL)
                        window.location.href = NEXT_CHAPTER_URL;
                    break;
                case "-":
                case "_":
                    changeFontSize(-1);
                    break;
                case "=":
                case "+":
                    changeFontSize(1);
                    break;
            }
        });

        window.addEventListener(
            "scroll",
            () => {
                updateProgress();
                handleScrollFAB();
            },
            { passive: true },
        );

        window.addEventListener("resize", updateProgress);

        const navObserver = new IntersectionObserver((entries) => {
            if (!entries[0].isIntersecting) {
                navBar.classList.add("stuck");
            } else {
                navBar.classList.remove("stuck");
            }
        });

        function init() {
            updateNavigation();
            loadSettings();
            navObserver.observe(sentinel);
            saveReadingHistory();
        }

        init();
    </script>
</body>

</html>