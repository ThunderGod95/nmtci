<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{ page.title }} | No Money to Cultivate Immortality</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Baskervville:ital,wght@0,400..700;1,400..700&family=Coming+Soon&family=Merriweather+Sans:ital,wght@0,300..800;1,300..800&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --font-family: "Open Sans", sans-serif;
                --text-size: 16px;
                --line-height: 1.6;
                --bg-color: #fdfdfd;
                --text-color: #333;
                --accent-color: #333;
                --menu-bg: #ffffff;
                --shadow-color: rgba(0, 0, 0, 0.1);
                --border-color: #e0e0e0;
            }

            [data-theme="dark"] {
                --menu-bg: #2d2d2d;
                --shadow-color: rgba(0, 0, 0, 0.5);
                --border-color: #444;
                --accent-color: #fff;
            }

            [data-theme="sepia"] {
                --menu-bg: #f4ecd8;
                --border-color: #d3c4a9;
                --accent-color: #5b4636;
            }

            * {
                box-sizing: border-box;
            }

            body {
                margin: 0;
                padding: 0;
                max-width: none;
                background-color: var(--bg-color);
                color: var(--text-color);
                font-size: var(--text-size);
                line-height: var(--line-height);
                font-family: var(--font-family);
                transition:
                    font-size 0.1s ease-in-out,
                    line-height 0.1s ease-in-out,
                    width 0.1s ease-in-out,
                    background-color 0.1s ease-in-out,
                    color 0.1s ease-in-out;
                overflow-x: hidden;
            }

            #content {
                max-width: 800px;
                margin: 0 auto;
                padding: 40px 20px;
            }

            /* --- Progress Bar --- */
            #progress-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 4px;
                background: transparent;
                z-index: 2000;
            }

            #progress-bar {
                height: 100%;
                background: var(--accent-color);
                width: 0%;
                transition: width 0.1s;
                opacity: 0.8;
            }

            /* --- FAB & Menu Container --- */
            .fab-container {
                position: fixed;
                bottom: 30px;
                right: 30px;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                pointer-events: none;
                transition:
                    transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                    opacity 0.3s ease;
                opacity: 1;
            }

            .fab-container.fab-hidden {
                transform: translateY(100px);
                opacity: 0;
            }

            .settings-btn {
                background-color: var(--text-color);
                color: var(--bg-color);
                border: none;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                box-shadow: 0 4px 12px var(--shadow-color);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: transform 0.2s
                    cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            .settings-btn:hover {
                transform: scale(1.1);
            }

            .settings-btn svg {
                fill: var(--bg-color);
                width: 24px;
                height: 24px;
            }

            .settings-menu {
                background: var(--menu-bg);
                color: var(--text-color);
                border: 1px solid var(--border-color);
                padding: 24px;
                border-radius: 16px;
                margin-bottom: 16px;
                box-shadow: 0 10px 40px -10px var(--shadow-color);
                width: 300px;
                opacity: 0;
                visibility: hidden;
                transform: translateY(10px) scale(0.98);
                transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                transform-origin: bottom right;
            }

            .settings-menu.active {
                opacity: 1;
                visibility: visible;
                transform: translateY(0) scale(1);
            }

            .setting-item {
                margin-bottom: 20px;
            }

            .setting-item:last-child {
                margin-bottom: 0;
            }

            .setting-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }

            .setting-item label {
                font-size: 13px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-color);
                opacity: 0.8;
            }

            .value-display {
                font-size: 13px;
                font-weight: bold;
                color: var(--text-color);
            }

            .settings-btn,
            .settings-menu {
                pointer-events: auto;
            }

            input[type="range"] {
                -webkit-appearance: none;
                width: 100%;
                background: transparent;
                cursor: pointer;
            }

            input[type="range"]:focus {
                outline: none;
            }

            input[type="range"]::-webkit-slider-runnable-track {
                width: 100%;
                height: 6px;
                cursor: pointer;
                background: var(--border-color);
                border-radius: 3px;
            }

            input[type="range"]::-webkit-slider-thumb {
                height: 18px;
                width: 18px;
                border-radius: 50%;
                background: var(--text-color);
                cursor: pointer;
                -webkit-appearance: none;
                margin-top: -6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                transition: transform 0.1s;
            }

            input[type="range"]::-webkit-slider-thumb:hover {
                transform: scale(1.1);
            }

            .select-wrapper {
                position: relative;
            }

            .select-wrapper::after {
                content: "▼";
                font-size: 10px;
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                pointer-events: none;
                color: var(--text-color);
            }

            select {
                appearance: none;
                -webkit-appearance: none;
                width: 100%;
                padding: 10px 12px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                background-color: transparent;
                color: var(--text-color);
                font-size: 14px;
                font-family: inherit;
                cursor: pointer;
                transition: border-color 0.2s;
            }

            select option {
                background-color: var(--menu-bg);
                color: var(--text-color);
            }

            select:hover {
                border-color: var(--text-color);
            }

            select:focus {
                outline: none;
                border-color: var(--text-color);
                box-shadow: 0 0 0 2px var(--shadow-color);
            }

            /* --- Theme Selector --- */
            .theme-selector {
                display: flex;
                gap: 12px;
                background: var(--border-color);
                padding: 6px;
                border-radius: 50px;
                width: fit-content;
            }

            .theme-btn {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                border: 2px solid transparent;
                cursor: pointer;
                transition: all 0.2s;
                position: relative;
            }

            .theme-btn.active {
                transform: scale(1.1);
                border-color: var(--text-color);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }

            /* --- Navigation Links --- */
            .chapter-nav {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 20px;
                max-width: 800px;
                margin: 0 auto;
                padding: 0 20px;
                width: 100%;
                user-select: none;
            }

            .sticky-bar {
                position: -webkit-sticky;
                position: sticky;
                top: 0;
                z-index: 900;
                width: 100%;
                background-color: var(--bg-color);
                padding: 15px 0;
                border-bottom: 1px solid transparent;
                transition:
                    box-shadow 0.3s ease,
                    border-color 0.3s ease;
            }

            .bottom-nav {
                padding-top: 20px;
                padding-bottom: 60px; /* Extra space for FAB */
            }

            .sticky-bar.stuck {
                border-bottom: 1px solid var(--border-color);
                box-shadow: 0 4px 6px -4px var(--shadow-color);
            }

            .nav-link {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 12px 24px;
                border: 1px solid var(--border-color);
                border-radius: 50px;
                color: var(--text-color);
                text-decoration: none;
                transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                font-weight: 600;
                font-size: 0.9rem;
                letter-spacing: 0.5px;
                background-color: transparent;
                min-width: 120px;
            }

            .nav-link:not(.disabled):hover {
                background-color: var(--text-color);
                color: var(--bg-color);
                border-color: var(--text-color);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px var(--shadow-color);
            }

            .nav-link:active {
                transform: scale(0.95);
            }

            .nav-link.disabled {
                opacity: 0;
                pointer-events: none;
                visibility: hidden;
            }

            #sentinel {
                position: absolute;
                top: 0;
                left: 0;
                height: 1px;
                width: 100%;
                pointer-events: none;
                visibility: hidden;
            }

            .chapter-nav.sticky-top {
                position: -webkit-sticky;
                position: sticky;
                top: 0;
                z-index: 900;
                background-color: var(--bg-color);
                margin-top: 0;
                margin-bottom: 20px;
                padding: 15px 20px;
                border-bottom: 1px solid transparent;
                box-shadow: none;
                transition:
                    box-shadow 0.3s ease,
                    border-color 0.3s ease;
            }

            .chapter-nav.sticky-top.stuck {
                border-bottom: 1px solid var(--border-color);
                box-shadow: 0 4px 6px -4px var(--shadow-color);
            }

            @media (max-width: 600px) {
                body {
                    padding-top: 20px;
                }

                .chapter-nav {
                    margin: 0;
                    gap: 8px;
                }

                #content {
                    padding-top: 15px;
                }

                .settings-menu {
                    position: fixed;
                    width: auto;
                    left: 20px;
                    right: 20px;
                    bottom: 100px;
                    margin-bottom: 0;
                    transform-origin: bottom center;
                }

                .nav-link {
                    padding: 10px 5px;
                    flex: 1;
                    min-width: 0;
                    font-size: 0.85rem;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    overflow: hidden;
                }

                .chapter-nav.sticky-top {
                    padding: 10px 15px;
                }

                h1 {
                    font-size: 1.5rem;
                    line-height: 1.3;
                    margin-top: 0;
                    margin-bottom: 20px;
                }
            }
        </style>
    </head>

    <body>
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>

        <div id="sentinel"></div>

        <div class="sticky-bar" id="topNav">
            <nav class="chapter-nav">
                <a class="nav-link nav-prev">← Previous</a>
                <a class="nav-link nav-toc" href="../">Index</a>
                <a class="nav-link nav-next">Next →</a>
            </nav>
        </div>

        <div id="content">{{ content }}</div>

        <nav class="chapter-nav bottom-nav">
            <a class="nav-link nav-prev">← Previous</a>
            <a class="nav-link nav-toc" href="../">Index</a>
            <a class="nav-link nav-next">Next →</a>
        </nav>

        <div class="fab-container">
            <div class="settings-menu" id="settingsMenu">
                <div class="setting-item">
                    <div class="setting-header">
                        <label>Font Size</label>
                        <span id="fs-val" class="value-display">18px</span>
                    </div>
                    <input
                        type="range"
                        id="input-fontsize"
                        min="14"
                        max="32"
                        value="18"
                    />
                </div>

                <div class="setting-item">
                    <div class="setting-header">
                        <label>Line Height</label>
                        <span id="lh-val" class="value-display">1.6</span>
                    </div>
                    <input
                        type="range"
                        id="input-lineheight"
                        min="1.2"
                        max="2.4"
                        step="0.1"
                        value="1.6"
                    />
                </div>

                <div class="setting-item">
                    <div class="setting-header">
                        <label for="input-font">Typeface</label>
                    </div>
                    <div class="select-wrapper">
                        <select id="input-font">
                            <option value="'Open Sans', sans-serif">
                                Open Sans (Sans)
                            </option>
                            <option value="'Baskervville', serif">
                                Baskervville (Serif)
                            </option>
                            <option value="'Merriweather Sans', sans-serif">
                                Merriweather (Sans)
                            </option>
                            <option value="'Nunito Sans', sans-serif">
                                Nunito (Sans)
                            </option>
                            <option value="'Coming Soon', cursive">
                                Handwritten
                            </option>
                        </select>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-header">
                        <label>Theme</label>
                    </div>
                    <div class="theme-selector">
                        <button
                            class="theme-btn"
                            data-theme="light"
                            style="background-color: #fdfdfd"
                            title="Light"
                            aria-label="Light Theme"
                        ></button>

                        <button
                            class="theme-btn"
                            data-theme="sepia"
                            style="background-color: #f4ecd8"
                            title="Sepia"
                            aria-label="Sepia Theme"
                        ></button>

                        <button
                            class="theme-btn"
                            data-theme="dark"
                            style="background-color: #222222"
                            title="Dark"
                            aria-label="Dark Theme"
                        ></button>
                    </div>
                </div>
            </div>

            <button
                class="settings-btn"
                id="toggleSettings"
                aria-label="Settings"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    height="24"
                    width="24"
                    viewBox="0 0 640 640"
                >
                    <path
                        d="M259.1 73.5C262.1 58.7 275.2 48 290.4 48L350.2 48C365.4 48 378.5 58.7 381.5 73.5L396 143.5C410.1 149.5 423.3 157.2 435.3 166.3L503.1 143.8C517.5 139 533.3 145 540.9 158.2L570.8 210C578.4 223.2 575.7 239.8 564.3 249.9L511 297.3C511.9 304.7 512.3 312.3 512.3 320C512.3 327.7 511.8 335.3 511 342.7L564.4 390.2C575.8 400.3 578.4 417 570.9 430.1L541 481.9C533.4 495 517.6 501.1 503.2 496.3L435.4 473.8C423.3 482.9 410.1 490.5 396.1 496.6L381.7 566.5C378.6 581.4 365.5 592 350.4 592L290.6 592C275.4 592 262.3 581.3 259.3 566.5L244.9 496.6C230.8 490.6 217.7 482.9 205.6 473.8L137.5 496.3C123.1 501.1 107.3 495.1 99.7 481.9L69.8 430.1C62.2 416.9 64.9 400.3 76.3 390.2L129.7 342.7C128.8 335.3 128.4 327.7 128.4 320C128.4 312.3 128.9 304.7 129.7 297.3L76.3 249.8C64.9 239.7 62.3 223 69.8 209.9L99.7 158.1C107.3 144.9 123.1 138.9 137.5 143.7L205.3 166.2C217.4 157.1 230.6 149.5 244.6 143.4L259.1 73.5zM320.3 400C364.5 399.8 400.2 363.9 400 319.7C399.8 275.5 363.9 239.8 319.7 240C275.5 240.2 239.8 276.1 240 320.3C240.2 364.5 276.1 400.2 320.3 400z"
                    />
                </svg>
            </button>
        </div>

        <script>
            const root = document.documentElement;
            const menu = document.getElementById("settingsMenu");
            const btn = document.getElementById("toggleSettings");
            const inputFs = document.getElementById("input-fontsize");
            const inputLh = document.getElementById("input-lineheight");
            const displayFs = document.getElementById("fs-val");
            const displayLh = document.getElementById("lh-val");
            const progressBar = document.getElementById("progress-bar");
            const inputFont = document.getElementById("input-font");

            const scrollKey =
                "reader-scroll-" +
                window.location.pathname +
                window.location.search;

            const themes = {
                light: { bg: "#fdfdfd", text: "#333333" },
                sepia: { bg: "#f4ecd8", text: "#5b4636" },
                dark: { bg: "#222222", text: "#d1d1d1" },
            };

            function updateThemeUI(activeTheme) {
                document.querySelectorAll(".theme-btn").forEach((btn) => {
                    if (btn.dataset.theme === activeTheme) {
                        btn.classList.add("active");
                    } else {
                        btn.classList.remove("active");
                    }
                });
            }

            function applyTheme(themeName) {
                const theme = themes[themeName] || themes.light;
                root.style.setProperty("--bg-color", theme.bg);
                root.style.setProperty("--text-color", theme.text);
                root.setAttribute("data-theme", themeName);
                updateThemeUI(themeName);
                return themeName;
            }

            function loadSettings() {
                const savedSettings = localStorage.getItem("reader-settings");
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);

                    root.style.setProperty(
                        "--text-size",
                        settings.fontSize + "px",
                    );
                    root.style.setProperty(
                        "--line-height",
                        settings.lineHeight,
                    );

                    if (settings.fontFamily) {
                        root.style.setProperty(
                            "--font-family",
                            settings.fontFamily,
                        );
                        inputFont.value = settings.fontFamily;
                    }

                    inputFs.value = settings.fontSize;
                    inputLh.value = settings.lineHeight;
                    displayFs.textContent = settings.fontSize + "px";
                    displayLh.textContent = settings.lineHeight;

                    applyTheme(settings.theme || "light");
                } else {
                    applyTheme("light");
                }

                const savedScroll = localStorage.getItem(scrollKey);
                if (savedScroll) {
                    setTimeout(() => {
                        window.scrollTo(0, parseInt(savedScroll));
                    }, 100);
                }
            }

            function saveSettings() {
                const activeBtn = document.querySelector(".theme-btn.active");
                const currentTheme = activeBtn
                    ? activeBtn.dataset.theme
                    : "light";

                const settings = {
                    fontSize: inputFs.value,
                    lineHeight: inputLh.value,
                    theme: currentTheme,
                    fontFamily: inputFont.value,
                };
                localStorage.setItem(
                    "reader-settings",
                    JSON.stringify(settings),
                );
            }

            function updateProgress() {
                const scrollTop = window.scrollY;
                const docHeight =
                    document.body.scrollHeight - window.innerHeight;
                const scrollPercent = (scrollTop / docHeight) * 100;
                progressBar.style.width = scrollPercent + "%";
                localStorage.setItem(scrollKey, scrollTop);
            }

            document.querySelectorAll(".theme-btn").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    const themeName = e.target.dataset.theme;
                    applyTheme(themeName);
                    saveSettings();
                });
            });

            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                menu.classList.toggle("active");
            });

            document.addEventListener("click", (e) => {
                if (
                    menu.classList.contains("active") &&
                    !menu.contains(e.target)
                ) {
                    menu.classList.remove("active");
                }
            });

            menu.addEventListener("click", (e) => {
                e.stopPropagation();
            });

            inputFs.addEventListener("input", (e) => {
                const val = e.target.value;
                root.style.setProperty("--text-size", val + "px");
                displayFs.textContent = val + "px";
                saveSettings();
            });

            inputLh.addEventListener("input", (e) => {
                const val = e.target.value;
                root.style.setProperty("--line-height", val);
                displayLh.textContent = val;
                saveSettings();
            });

            inputFont.addEventListener("change", (e) => {
                const val = e.target.value;
                root.style.setProperty("--font-family", val);
                saveSettings();
            });

            window.addEventListener("scroll", updateProgress);
            window.addEventListener("resize", updateProgress);

            const prevNum = "{{ page.prev }}";
            const nextNum = "{{ page.next }}";

            const prevChapterUrl = prevNum ? `${prevNum}.html` : "";
            const nextChapterUrl = nextNum ? `${nextNum}.html` : "";

            document.addEventListener("keydown", (e) => {
                switch (e.key) {
                    case "ArrowLeft":
                        if (prevChapterUrl && prevChapterUrl.trim() !== "") {
                            window.location.href = prevChapterUrl;
                        }
                        break;
                    case "ArrowRight":
                        if (nextChapterUrl && nextChapterUrl.trim() !== "") {
                            window.location.href = nextChapterUrl;
                        }
                        break;
                    case "-":
                    case "_":
                        changeFontSize(-1);
                        break;
                    case "=":
                    case "+":
                        changeFontSize(1);
                        break;
                }
            });

            function changeFontSize(delta) {
                const currentVal = parseInt(inputFs.value);
                const minVal = parseInt(inputFs.min);
                const maxVal = parseInt(inputFs.max);

                let newVal = currentVal + delta;

                if (newVal >= minVal && newVal <= maxVal) {
                    inputFs.value = newVal;
                    inputFs.dispatchEvent(new Event("input"));
                }
            }

            function updateNavigation() {
                const prevLinks = document.querySelectorAll(".nav-prev");
                const nextLinks = document.querySelectorAll(".nav-next");

                prevLinks.forEach((link) => {
                    if (prevChapterUrl && prevChapterUrl.trim() !== "") {
                        link.href = prevChapterUrl;
                        link.classList.remove("disabled");
                    } else {
                        link.removeAttribute("href");
                        link.classList.add("disabled");
                    }
                });

                nextLinks.forEach((link) => {
                    if (nextChapterUrl && nextChapterUrl.trim() !== "") {
                        link.href = nextChapterUrl;
                        link.classList.remove("disabled");
                    } else {
                        link.removeAttribute("href");
                        link.classList.add("disabled");
                    }
                });
            }

            updateNavigation();
            loadSettings();

            const nav = document.getElementById("topNav");
            const sentinel = document.getElementById("sentinel");

            const observer = new IntersectionObserver((entries) => {
                if (!entries[0].isIntersecting) {
                    nav.classList.add("stuck");
                } else {
                    nav.classList.remove("stuck");
                }
            });

            observer.observe(sentinel);

            const fabContainer = document.querySelector(".fab-container");
            let lastScrollTop = 0;

            window.addEventListener(
                "scroll",
                () => {
                    const scrollTop =
                        window.scrollY || document.documentElement.scrollTop;

                    if (Math.abs(scrollTop - lastScrollTop) < 10) return;

                    const isScrollingDown = scrollTop > lastScrollTop;
                    const isMenuOpen = menu.classList.contains("active");

                    if (isScrollingDown && scrollTop > 50 && !isMenuOpen) {
                        fabContainer.classList.add("fab-hidden");
                    } else if (!isScrollingDown) {
                        fabContainer.classList.remove("fab-hidden");
                    }

                    lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
                },
                { passive: true },
            );
        </script>
    </body>
</html>
